upstream juice_shop {
    server juice-shop:3000;  # Simple service name - no host.docker.internal needed!
    keepalive 32;
}

upstream waf_inference {
    server waf-inference:5000;
    keepalive 16;
}

log_format waf_log escape=json '{'
    '"timestamp":"$time_iso8601",'
    '"client_ip":"$remote_addr",'
    '"method":"$request_method",'
    '"uri":"$request_uri",'
    '"status":$status,'
    '"user_agent":"$http_user_agent",'
    '"request_id":"$request_id",'
    '"body":"$request_body"'
'}';

server {
    listen 80;
    server_name localhost;

    client_max_body_size 10M;
    client_body_buffer_size 128k;
    client_body_in_single_buffer on;

    access_log /var/log/nginx/waf_access.log waf_log;
    error_log /var/log/nginx/waf_error.log warn;

    location / {
        mirror /waf_mirror;
        mirror_request_body on;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        proxy_pass_request_body on;
        proxy_set_header Content-Length $content_length;

        proxy_connect_timeout 360s;
        proxy_send_timeout 360s;
        proxy_read_timeout 360s;

        proxy_pass http://juice_shop;
    }

    location = /waf_mirror {
        internal;
        proxy_ignore_client_abort on;
        proxy_method POST;

        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        proxy_set_header X-Client-IP $remote_addr;
        proxy_set_header X-Request-ID $request_id;
        proxy_set_header Content-Type application/json;
        
        proxy_pass http://waf-inference:5000/analyze;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
